<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Requests Management</title>
        <link rel="stylesheet" href="../../bootstrap-5.3.2-dist/css/bootstrap.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    </head>

    <style>
        .nav-pills .nav-link.active,
        .nav-pills .show>.nav-link {
          background-color: rgb(80, 102, 80);
          color: #ffffff;
        }
    
        .nav-pills .nav-link,
        .nav-pills .show>.nav-link,
        .nav-pills .nav-link {
          color: #000000;
        }
      </style>

    <body>

        <div class="container">
            <div class="row" style="background-color:rgb(80, 102, 80)">

                <div class="col-sm-12">
                    <img src="../../imgs/logo.png" class="img-thumbnail mx-auto d-block mt-4" width="150" height="45">
                </div>

            </div>
        </div>

        <div class="container mb-4">
            <div class="row" style="background-color:rgb(80, 102, 80)">

                <div class="btn-group mb-3">
                    <button type="button" class="btn btn-link mt-5">
                        <img src="../../imgs/home.png" class="img-thumbnail" width="45" height="45">
                    </button>

                    <button type="button" class="btn btn-link mt-5">
                        <img src="../../imgs/user.png" class="img-thumbnail" width="45" height="45">
                    </button>

                    <button type="button" class="btn btn-link mt-5">
                        <img src="../../imgs/power.png" class="img-thumbnail" width="45" height="45">
                    </button>
                </div> 

            </div>
        </div>

        <div class="container">
            <ul class="nav flex-column text-center nav-pills justify-content-center mt-4" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="pill" href="#new_request">New Request</a>
                </li>
        
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#accepted_requests">Accepted Requests</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#unaccepted_requests">Unaccepted Requests</a>
                </li>
        
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#completed_requests">Completed Requests</a>
                </li>
            </ul>
        </div>

        <div class="tab-content">
            <div class="tab-pane container text-white active mt-3" id="new_request">
                
                <div class="row">
                    <div class="col-lg-3"></div>
                    
                    <div class="col-lg-12 rounded" style="background-color:rgb(80, 102, 80)">
                        <h3 class="text-center mt-4">New Request</h3>
                        <form class="p-3">
                            <div class="mb-3 mt-3">
                                <label for="category" class="form-label">Category:</label>
                                <select class="form-select" id="categories_select_menu">
                                    <option>Select Category</option>
                                </select>
                            </div>

                            <div class="mb-4 mt-4">
                                <label for="product" class="form-label">Product:</label>
                                <input class="form-control" list="products" name="category" id="products_select_menu" placeholder="Select Product" autocomplete="off">
                                <datalist id="products">
    
                                </datalist> 
                            </div>

                            <div class="mb-4 mt-4">
                                <label for="description" class="form-label">Persons Number:</label>
                                <input type="number" value="1" min="1" class="form-control" id="spinner">
                            </div>
                
                            <div class="mb-1 mt-3 text-center">
                                <button type="button" class="btn btn-primary btn-default mt-3" id="add_request_btn">Add Request</button>
                            </div>
                        </form>
                    </div>
            
                </div>
            </div>
            

            <div class="tab-pane container fade mt-4" id="accepted_requests">
                
            </div>
            
            <div class="tab-pane container fade mt-4" id="unaccepted_requests">
                
            </div>

            <div class="tab-pane container fade mt-4" id="completed_requests">
            
            </div>
        </div>
       

    </body>

    <script>
        let minDistanceBase;

        fetch('http://localhost:3000/citizen_info/marios_raftopoulos')
        .then(response => response.json())
        .then(async data1 => {
            let citizen_lat = data1.citizen_location.x;
            let citizen_lng = data1.citizen_location.y;

            let bases = [];
            bases.push({base_name: '', distance: Infinity});

            await fetch('http://localhost:3000/bases_info')
            .then(response => response.json())
            .then(data2 => {
                data2.forEach(item => {
                    let base_lat = item.base_location.x;
                    let base_lng = item.base_location.y;

                    let distance = L.latLng(citizen_lat, citizen_lng).distanceTo(L.latLng(base_lat, base_lng));
                    bases.push({
                        base_name: item.base_name, 
                        distance: distance
                    });
                })
            })
            .catch(error => console.error('Error fetching data:', error));

            minDistanceBase = bases.reduce((min, current) => 
                current['distance'] < min['distance'] ? current : min
            );

            fetch('http://localhost:3000/base_categories/' + minDistanceBase.base_name)
            .then(response => response.json())
            .then(data => {
                data.forEach(item => {
                    let option = document.createElement('option');
                    option.textContent = item.category_name;
                    option.id = 'category_' + item.category_id;
                    document.getElementById('categories_select_menu').appendChild(option);
                })
            })
            .catch(error => console.error('Error fetching data:', error));

            fetch('http://localhost:3000/base_products/' + minDistanceBase.base_name)
            .then(response => response.json())
            .then(data => {
                data.forEach(item => {
                    let option = document.createElement('option');
                    option.textContent = item.product_name;
                    option.id = 'product_' + item.id;
                    document.getElementById('products').appendChild(option);
                })
            })
            .catch(error => console.error('Error fetching data:', error));
        })
        .catch(error => console.error('Error fetching data:', error));


        function acceptedRequests(){
            fetch('http://localhost:3000/citizen_active_tasks/requests/accepted/marios_raftopoulos')
            .then(response => response.json())
            .then(data => {
                
                if(Object.keys(data).length > 0){
                    data.forEach(item => {
                        let container = document.createElement('div');
                        container.className = 'container mt-4';

                        let card = document.createElement('div');
                        card.className = 'card';

                        let header = document.createElement('div');
                        header.className = 'card-header';
                        header.textContent = 'Task ID: ' + item.task_id;

                        let body = document.createElement('div');
                        body.className = 'card-body';
                        body.innerHTML = `
                            <p><b>Product: </b>${item.product_name}</p>
                            <p><b>Quantity: </b>${item.persons_num}</p>
                            <p><b>Rescuer: </b>${item.username}</p>
                            <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -5)}</p>
                            <p><b>Accept Date: </b>${item.accept_date.replace('T','  ').slice(0, -5)}</p>

                            <div class="mb-1 mt-3 text-center">
                                <button type="button" class="btn btn-outline-danger mt-3" id="${item.task_id}">Cancel Request</button>
                            </div>
                        `;

                        card.appendChild(header);
                        card.appendChild(body);
                        container.appendChild(card);
                        document.getElementById('accepted_requests').appendChild(container);

                        document.getElementById(item.task_id).addEventListener('click', function() {  
                            fetch('http://localhost:3000/cancel_request/' + item.task_id + '/' + 'marios_raftopoulos', { method: 'POST' })
                            .then(response => response.text())
                            .then(data => {
                                if (data == "success"){
                                    alert("Request canceled successfully");
                                    document.getElementById('accepted_requests').innerHTML = '';
                                    acceptedRequests();
                                }
                            })
                            .catch(error => console.error('Error fetching data:', error));
                        });
                    })
                }else{
                    let listGroup = document.createElement('ul');
                    listGroup.className = 'list-group';

                    let listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-center align-items-center';
                    listItem.textContent = 'No accepted requests';

                    listGroup.appendChild(listItem);
                    document.getElementById('accepted_requests').appendChild(listGroup);
                }

            })
            .catch(error => console.error('Error fetching data:', error));

        }
        

        function unacceptedRequests(){
            fetch('http://localhost:3000/citizen_active_tasks/requests/unaccepted/marios_raftopoulos')
            .then(response => response.json())
            .then(data => {
                
                if(Object.keys(data).length > 0){
                    data.forEach(item => {
                        let container = document.createElement('div');
                        container.className = 'container mt-4';

                        let card = document.createElement('div');
                        card.className = 'card';

                        let header = document.createElement('div');
                        header.className = 'card-header';
                        header.textContent = 'Task ID: ' + item.task_id;

                        let body = document.createElement('div');
                        body.className = 'card-body';
                        body.innerHTML = `
                            <p><b>Product: </b>${item.product_name}</p>
                            <p><b>Quantity: </b>${item.persons_num}</p>
                            <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -5)}</p>

                            <div class="mb-1 mt-3 text-center">
                                <button type="button" class="btn btn-outline-danger mt-3" id="${item.task_id}">Cancel Request</button>
                            </div>
                        `;

                        card.appendChild(header);
                        card.appendChild(body);
                        container.appendChild(card);
                        document.getElementById('unaccepted_requests').appendChild(container);

                        document.getElementById(item.task_id).addEventListener('click', function() {  
                            fetch('http://localhost:3000/cancel_request/' + item.task_id + '/' + 'marios_raftopoulos', { method: 'POST' })
                            .then(response => response.text())
                            .then(data => {
                                if (data == "success"){
                                    alert("Request canceled successfully");
                                    document.getElementById('unaccepted_requests').innerHTML = '';
                                    unacceptedRequests();
                                }
                            })
                            .catch(error => console.error('Error fetching data:', error));
                        });
                    })
                }else{
                    let listGroup = document.createElement('ul');
                    listGroup.className = 'list-group';

                    let listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-center align-items-center';
                    listItem.textContent = 'No unaccepted requests';

                    listGroup.appendChild(listItem);
                    document.getElementById('unaccepted_requests').appendChild(listGroup);
                }

            })
            .catch(error => console.error('Error fetching data:', error));
        }


        function completedRequests(){
            fetch('http://localhost:3000/citizen_completed_tasks/requests/marios_raftopoulos')
            .then(response => response.json())
            .then(data => {

                if(Object.keys(data).length > 0){
                    data.forEach(item => {
                        let container = document.createElement('div');
                        container.className = 'container mt-4';

                        let card = document.createElement('div');
                        card.className = 'card';

                        let header = document.createElement('div');
                        header.className = 'card-header';
                        header.textContent = 'Task ID: ' + item.task_id;

                        let body = document.createElement('div');
                        body.className = 'card-body';
                        body.innerHTML = `
                            <p><b>Product: </b>${item.product_name}</p>
                            <p><b>Quantity: </b>${item.persons_num}</p>
                            <p><b>Rescuer: </b>${item.username}</p>
                            <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -5)}</p>
                            <p><b>Accept Date: </b>${item.accept_date.replace('T','  ').slice(0, -5)}</p>
                            <p><b>Complete Date: </b>${item.complete_date.replace('T','  ').slice(0, -5)}</p>
                        `;

                        card.appendChild(header);
                        card.appendChild(body);
                        container.appendChild(card);
                        document.getElementById('completed_requests').appendChild(container);
                    })
                }else{
                    let listGroup = document.createElement('ul');
                    listGroup.className = 'list-group';

                    let listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-center align-items-center';
                    listItem.textContent = 'No completed requests';

                    listGroup.appendChild(listItem);
                    document.getElementById('completed_requests').appendChild(listGroup);
                }

            })
            .catch(error => console.error('Error fetching data:', error));
        }


        document.getElementById('spinner').addEventListener('input', function() {
            if (parseInt(spinner.value) < 1){
                spinner.value = 1;
            }
        });


        document.getElementById('categories_select_menu').addEventListener('change', function(){
            let selectedOption = document.getElementById('categories_select_menu').options[document.getElementById('categories_select_menu').selectedIndex];

            if(this.value == 'Select Category'){
                fetch('http://localhost:3000/base_products/' + minDistanceBase.base_name)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('products').innerHTML = '';
                    data.forEach(item => {
                        let option = document.createElement('option');
                        option.textContent = item.product_name;
                        option.id = 'product_' + item.id;
                        document.getElementById('products').appendChild(option);
                    })
                })
                .catch(error => console.error('Error fetching data:', error));
            }else{
                category = selectedOption.id.split('_')[1];
                fetch('http://localhost:3000/base_products/' + minDistanceBase.base_name + '/' + category)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('products').innerHTML = '';
                    data.forEach(item => {
                        let option = document.createElement('option');
                        option.textContent = item.product_name;
                        option.id = 'product_' + item.id;
                        document.getElementById('products').appendChild(option);
                    })
                })
                .catch(error => console.error('Error fetching data:', error));
            }

        });


        document.getElementById('add_request_btn').addEventListener('click', function() {  
            let product = document.getElementById('products_select_menu').value;
            let product_id;

            Array.from(document.getElementById('products').options).forEach(item => {
                if (item.value == product){
                    product_id = parseFloat(item.id.split('_')[1]);
                }
            });

            let persons = document.getElementById('spinner').value;

            if (product == undefined){
                alert('Product is not valid!');
            }
            else{
                fetch('http://localhost:3000/new_request/' + product_id + '/' + persons + '/marios_raftopoulos', { method: 'POST' })
                .then(response => response.text())
                .then(data => {
                    if (data == "success"){
                        alert("Request added successfully");
                        document.getElementById('products_select_menu').value = '';
                        document.getElementById('spinner').value = 1;
                        document.getElementById('categories_select_menu').value = 'Select Category';
                        document.getElementById('active_requests').innerHTML = '';
                        unacceptedRequests();
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
            }
        });

        acceptedRequests();
        unacceptedRequests();
        completedRequests();

    </script>

</html>