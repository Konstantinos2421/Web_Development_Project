<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offers Management</title>
    <link rel="stylesheet" href="../../bootstrap-5.3.2-dist/css/bootstrap.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        if (sessionStorage.getItem('loggedIn') != 'yes') {
          window.location.href = "../login/login.html";
        }else if(sessionStorage.getItem('userType') != 'citizen'){
          let user_type = sessionStorage.getItem('userType');
          window.location.href = '../' + user_type + '/' + user_type + '_home.html';
        }
    </script>
  </head>

  <style>
    .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
      background-color: rgb(80, 102, 80);
      color: #ffffff;
    }

    .nav-pills .nav-link, .nav-pills .show > .nav-link, .nav-pills .nav-link {
        color: #000000;
    }
  </style>
    
  <body>

    <div class="container">
        <div class="row" style="background-color:rgb(80, 102, 80)">

            <div class="col-sm-12">
                <img src="../../imgs/logo.png" class="img-thumbnail mx-auto d-block mt-4" width="150" height="45">
            </div>

        </div>
    </div>

    <div class="container">
        <div class="row" style="background-color:rgb(80, 102, 80)">

            <div class="btn-group mb-3">
                <button type="button" class="btn btn-link mt-5" id="home_btn">
                    <img src="../../imgs/home.png" class="img-thumbnail" width="45" height="45">
                </button>

                <div class="dropdown">
                    <button type="button" class="btn btn-link mt-5" data-bs-toggle="dropdown">
                        <img src="../../imgs/user.png" class="img-thumbnail" width="45" height="45">
                    </button>
                    <div class="dropdown-menu p-3" id="user_info">
                        <script>
                            document.getElementById('user_info').innerHTML = `
                                <div class="text-center">
                                    <b class="font-weight-bold">${sessionStorage.getItem('username')}</b>
                                </div>
                            `;
                        </script>
                    </div>
                </div>

                <button type="button" class="btn btn-link mt-5" id="power_btn">
                    <img src="../../imgs/power.png" class="img-thumbnail" width="45" height="45">
                </button>
            </div> 

        </div>
    </div>

    <ul class="nav flex-column text-center nav-pills justify-content-center mt-4" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="pill" href="#announcements">Announcements</a>
        </li>

        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#accepted_offers">Accepted offers</a>
        </li>

        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#unaccepted_offers">Unaccepted offers</a>
        </li>

        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="pill" href="#completed_offers">Completed offers</a>
        </li>
    </ul>

    <div class="tab-content mt-3 mb-2">
        <div class="tab-pane container active" id="announcements">
           
        </div>
        
        <div class="tab-pane container fade" id="accepted_offers">
            
        </div>

        <div class="tab-pane container fade" id="unaccepted_offers">
           
        </div>

        <div class="tab-pane container fade" id="completed_offers">
            
        </div>
    </div>

    

  </body>

  <script>
    document.getElementById('home_btn').addEventListener('click', function () {
        location.href = './citizen_home.html';
    });
  
    document.getElementById('power_btn').addEventListener('click', function () {
        fetch('http://localhost:3000/logout', {method: 'POST'})
        .then(response => response.text())
        .then(data => {
          if (data == 'success') {
            sessionStorage.setItem('loggedIn', 'no');
            sessionStorage.setItem('userType', '');
            location.href = '../login/login.html';
          }
        })
        .catch(error => console.error('Error fetching data:', error));
    });

    let citizen = sessionStorage.getItem('username');

    function announcements() {

        fetch('http://localhost:3000/citizen/announcements')
        .then(response => response.json())
        .then(data => {
            let dataContainer = document.getElementById('announcements');

            if(Object.keys(data).length > 0){
                data.forEach(item => {
                    if (!document.getElementById('ann_' + item.announcement_id)){
                        let modal = document.createElement('div');
                        modal.className = 'modal';
                        modal.id = 'modal_' + item.id;

                        let modal_dialog = document.createElement('div');
                        modal_dialog.className = 'modal-dialog';

                        let modal_content = document.createElement('div');
                        modal_content.className = 'modal-content';
                        modal_content.innerHTML = `
                            <div class="modal-header">
                                <h4 class="modal-title">Product Quantity</h4>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                    
                            <div class="modal-body">
                                <input type="number" value="1" min="1" class="form-control" id="spinner_${item.id}">
                            </div>
                    
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="offer_btn_${item.id}">Offer</button>
                            </div>
                        `;

                        modal_dialog.appendChild(modal_content);
                        modal.appendChild(modal_dialog);
                        document.getElementById('announcements').appendChild(modal);

                        let container = document.createElement('div');
                        container.className = 'container mt-4';

                        let cardItem = document.createElement('div');
                        cardItem.className = 'card';
                        cardItem.id = 'ann_' + item.announcement_id;
                        
                        let header = document.createElement('div');
                        header.className = 'card-header';
                        header.textContent = 'Announcement ID: ' + item.announcement_id;

                        let body = document.createElement('div');
                        body.className = 'card-body';
                        body.id = 'body_' + item.announcement_id;
                        body.innerHTML = `
                            <div class="container d-flex justify-content-between align-items-center">
                                <p class="mb-0"><b>Product: </b>${item.product_name}</p>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_${item.id}">Offer</button>
                            </div>
                        `;


                        document.getElementById('spinner_' + item.id).addEventListener('input', function(){
                            if (parseInt( document.getElementById('spinner_' + item.id).value) < 1){
                                document.getElementById('spinner_' + item.id).value = 1;
                            }
                        });


                        document.getElementById('offer_btn_' + item.id).addEventListener('click', function(){
                            let quantity = document.getElementById('spinner_' + item.id).value;
                            fetch('http://localhost:3000/new_offer/' + item.id + '/' + quantity + '/' + citizen, {method: 'POST'})
                            .then(response => response.text())
                            .then(data => {
                                if(data == 'success'){
                                    alert('Offer submitted successfully!');
                                    document.getElementById('unaccepted_offers').innerHTML = ''
                                    unacceptedOffers();
                                }
                            })
                            .catch(error => console.error('Error fetching data:', error));
                        });
                        
                        cardItem.appendChild(header);
                        cardItem.appendChild(body);
                        container.appendChild(cardItem);
                        dataContainer.appendChild(container);
                    }else{
                        let modal = document.createElement('div');
                        modal.className = 'modal';
                        modal.id = 'modal_' + item.id;

                        let modal_dialog = document.createElement('div');
                        modal_dialog.className = 'modal-dialog';

                        let modal_content = document.createElement('div');
                        modal_content.className = 'modal-content';
                        modal_content.innerHTML = `
                            <div class="modal-header">
                                <h4 class="modal-title">Product Quantity</h4>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                    
                            <div class="modal-body">
                                <input type="number" class="form-control" id="spinner_${item.id}">
                            </div>
                    
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="offer_btn_${item.id}">Offer</button>
                            </div>
                        `;

                        modal_dialog.appendChild(modal_content);
                        modal.appendChild(modal_dialog);
                        document.getElementById('announcements').appendChild(modal);

                        document.getElementById('body_' + item.announcement_id).innerHTML+=`
                            <div class="container d-flex justify-content-between align-items-center mt-3">
                                <p class="mb-0"><b>Product: </b>${item.product_name}</p>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_${item.id}">Offer</button>
                            </div>
                        `;

                        document.getElementById('offer_btn_' + item.id).addEventListener('click', function(){
                            let quantity = document.getElementById('spinner_' + item.id).value;
                            fetch('http://localhost:3000/new_offer/' + item.id + '/' + quantity + '/' + citizen, {method: 'POST'})
                            .then(response => response.text())
                            .then(data => {
                                if(data == 'success'){
                                    alert('Offer submitted successfully!');
                                    document.getElementById('unaccepted_offers').innerHTML = ''
                                    unacceptedOffers();
                                }
                            })
                            .catch(error => console.error('Error fetching data:', error));
                        });
                    }
                });
            }else{
                let listGroup = document.createElement('ul');
                listGroup.className = 'list-group';

                let listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-center align-items-center';
                listItem.textContent = 'No announcements found';

                listGroup.appendChild(listItem);
                document.getElementById('announcements').appendChild(listGroup);
            }
        })
        .catch(error => console.error('Error fetching data:', error));
    }


    function acceptedOffers(){
        fetch('http://localhost:3000/citizen_active_tasks/offers/accepted/' + citizen)
        .then(response => response.json())
        .then(data => {
            let dataContainer = document.getElementById('accepted_offers');

            if(Object.keys(data).length > 0){
                data.forEach(item => {
                    let container = document.createElement('div');
                    container.className = 'container mt-4';

                    let cardItem = document.createElement('div');
                    cardItem.className = 'card';
                    cardItem.id = 'offer_' + item.offer_id;
                            
                    let header = document.createElement('div');
                    header.className = 'card-header';
                    header.textContent = 'Offer ID: ' + item.offer_id;

                    let body = document.createElement('div');
                    body.className = 'card-body';
                    body.innerHTML = `
                        <p><b>Product: </b>${item.product_name}</p>
                        <p><b>Quantity: </b>${item.quantity}</p>
                        <p><b>Rescuer: </b>${item.username}</p>
                        <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -5)}</p>
                        <p><b>Accept Date: </b>${item.accept_date.replace('T','  ').slice(0, -5)}</p>

                        <div class="mb-1 mt-3 text-center">
                            <button type="button" class="btn btn-outline-danger mt-3" id="${item.task_id}">Cancel Offer</button>
                        </div>
                    `;
                            
                    cardItem.appendChild(header);
                    cardItem.appendChild(body);
                    container.appendChild(cardItem);
                    dataContainer.appendChild(container);

                    document.getElementById(item.task_id).addEventListener('click', function() {  
                        fetch('http://localhost:3000/cancel_offer/' + item.task_id + '/' + citizen, { method: 'POST' })
                        .then(response => response.text())
                        .then(data => {
                            if (data == 'success'){
                                alert('Offer canceled successfully');
                                document.getElementById('accepted_offers').innerHTML = '';
                                acceptedOffers();
                            }
                        })
                        .catch(error => console.error('Error fetching data:', error));
                    });
                })
            }else{
                let listGroup = document.createElement('ul');
                listGroup.className = 'list-group';

                let listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-center align-items-center';
                listItem.textContent = 'No accepted offers';

                listGroup.appendChild(listItem);
                document.getElementById('accepted_offers').appendChild(listGroup);
            }
        })
        .catch(error => console.error('Error fetching data:', error));
    }


    function unacceptedOffers(){
        fetch('http://localhost:3000/citizen_active_tasks/offers/unaccepted/' + citizen)
        .then(response => response.json())
        .then(data => {
            let dataContainer = document.getElementById('unaccepted_offers');

            if(Object.keys(data).length > 0){
                data.forEach(item => {
                    let container = document.createElement('div');
                    container.className = 'container mt-4';

                    let cardItem = document.createElement('div');
                    cardItem.className = 'card';
                    cardItem.id = 'offer_' + item.offer_id;
                            
                    let header = document.createElement('div');
                    header.className = 'card-header';
                    header.textContent = 'Offer ID: ' + item.offer_id;

                    let body = document.createElement('div');
                    body.className = 'card-body';
                    body.innerHTML = `
                        <p><b>Product: </b>${item.product_name}</p>
                        <p><b>Quantity: </b>${item.quantity}</p>
                        <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -5)}</p>

                        <div class="mb-1 mt-3 text-center">
                            <button type="button" class="btn btn-outline-danger mt-3" id="${item.task_id}">Cancel Offer</button>
                        </div>
                    `;
                            
                    cardItem.appendChild(header);
                    cardItem.appendChild(body);
                    container.appendChild(cardItem);
                    dataContainer.appendChild(container);

                    document.getElementById(item.task_id).addEventListener('click', function() {  
                        fetch('http://localhost:3000/cancel_offer/' + item.task_id + '/' + citizen, { method: 'POST' })
                        .then(response => response.text())
                        .then(data => {
                            if (data == 'success'){
                                alert('Offer canceled successfully');
                                document.getElementById('unaccepted_offers').innerHTML = '';
                                unacceptedOffers();
                            }
                        })
                        .catch(error => console.error('Error fetching data:', error));
                    });
                })
            }else{
                let listGroup = document.createElement('ul');
                listGroup.className = 'list-group';

                let listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-center align-items-center';
                listItem.textContent = 'No unaccepted offers';

                listGroup.appendChild(listItem);
                document.getElementById('unaccepted_offers').appendChild(listGroup);
            }
        })
        .catch(error => console.error('Error fetching data:', error));
    }


    function completedOffers(){
        fetch('http://localhost:3000/citizen_completed_tasks/offers/' + citizen)
        .then(response => response.json())
        .then(data => {
            let dataContainer = document.getElementById('completed_offers');

            if(Object.keys(data).length > 0){
                data.forEach(item => {
                    let container = document.createElement('div');
                    container.className = 'container mt-4';

                    let cardItem = document.createElement('div');
                    cardItem.className = 'card';
                    cardItem.id = 'ann_' + item.offer_id;
                            
                    let header = document.createElement('div');
                    header.className = 'card-header';
                    header.textContent = 'Offer ID: ' + item.offer_id;

                    let body = document.createElement('div');
                    body.className = 'card-body';
                    body.innerHTML = `
                        <p><b>Product: </b>${item.product_name}</p>
                        <p><b>Quantity: </b>${item.persons_num}</p>
                        <p><b>Rescuer: </b>${item.username}</p>
                        <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -5)}</p>
                        <p><b>Accept Date: </b>${item.accept_date.replace('T','  ').slice(0, -5)}</p>
                        <p><b>Complete Date: </b>${item.complete_date.replace('T','  ').slice(0, -5)}</p>
                    `;
                            
                    cardItem.appendChild(header);
                    cardItem.appendChild(body);
                    container.appendChild(cardItem);
                    dataContainer.appendChild(container);
                })
            }else{
                let listGroup = document.createElement('ul');
                listGroup.className = 'list-group';

                let listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-center align-items-center';
                listItem.textContent = 'No completed offers';

                listGroup.appendChild(listItem);
                document.getElementById('completed_offers').appendChild(listGroup);
            }
        })
        .catch(error => console.error('Error fetching data:', error));
    }

    announcements();
    acceptedOffers();
    unacceptedOffers();
    completedOffers();

  </script>

</html>