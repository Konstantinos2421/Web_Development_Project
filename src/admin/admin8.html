<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcements Management</title>
    <link rel="stylesheet" href="../../bootstrap-5.3.2-dist/css/bootstrap.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      if (localStorage.getItem('loggedIn') != 'yes') {
        window.location.href = "../login/login.html";
      }else if(localStorage.getItem('userType') != 'admin'){
        let user_type = localStorage.getItem('userType');
        window.location.href = '../' + user_type + '/' + user_type + '_home.html';
      }
    </script>
  </head>

  <style>
    .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
      background-color: rgb(80, 102, 80);
      color: #ffffff;
    }

    .nav-pills .nav-link, .nav-pills .show > .nav-link, .nav-pills .nav-link {
      color: #000000;
    }
  </style>

  <body>

    <div class="container-fluid">
      <div class="row" style="background-color:rgb(80, 102, 80)">
        <div class="col-lg-5"></div>

        <div class="col-lg-2 mb-4">
          <img src="../../imgs/logo.png" class="img-thumbnail mt-4 mx-auto d-block" height="45" width="170">
        </div>

        <div class="col-lg-3"></div>

        <div class="col-lg-2 mt-4">
          <div class="btn-group">
            <button type="button" class="btn btn-link" id="home_btn">
              <img src="../../imgs/home.png" class="img-thumbnail" width="45" height="45">
            </button>

            <div class="dropdown">
              <button type="button" class="btn btn-link" data-bs-toggle="dropdown">
                <img src="../../imgs/user.png" class="img-thumbnail" width="45" height="45">
              </button>
              <div class="dropdown-menu p-3" id="user_info">
                <script>
                  document.getElementById('user_info').innerHTML = `
                    <div class="text-center">
                      <b class="font-weight-bold">${localStorage.getItem('username')}</b>
                    </div>
                  `;
                </script>
              </div>
            </div>

            <button type="button" class="btn btn-link" id="power_btn">
              <img src="../../imgs/power.png" class="img-thumbnail" width="45" height="45">
            </button>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-pills justify-content-center mt-5" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="pill" href="#new_announcement">New Announcement</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#delete_announcement">Delete Announcement</a>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane container active mt-4" id="new_announcement">

        <div class="container text-white mt-5 mb-2" id="test">
          <div class="row">
            <div class="col-lg-3"></div>
            
            <div class="col-lg-6 rounded" style="background-color:rgb(80, 102, 80)">
              <h4 class="text-center mt-4">New Announcement</h4>
              <form class="p-3">
                <div>
                  <label for="product" class="form-label">Product:</label>
                  <select class="form-select" id="product_select_menu">
                    <option id="-1">Choose Product</option>
                  </select>
                </div>
            
                <div class="mb-3 mt-3 text-center" id="add_product_btn_div">
                  <button type="button" class="btn" id="add_product_btn">
                    <img src="../../imgs/add.png" class="img-thumbnail" width="40" height="40">
                    <label class="form-label text-white">Add Product</label>
                  </button>
                </div>
    
                <div class="mb-3 mt-3 text-center">
                  <button type="button" class="btn btn-primary btn-default mt-3" id="add_announcement_btn">Add Announcement</button>
                </div>
              </form>
            </div>
    
          </div>
        </div>

      </div>
      
      <div class="tab-pane container fade mt-4" id="delete_announcement">
        <div class="row">
          <div class="col-lg-3"></div>

          <div class="col-lg-6" id="announcements">

          </div>
        </div>
      </div>
    </div>

  </body>

  <script>
    document.getElementById('home_btn').addEventListener('click', function () {
      location.href = './admin_home.html';
    });

    document.getElementById('power_btn').addEventListener('click', function () {
      localStorage.setItem('loggedIn', 'no');
      localStorage.setItem('userType', '');
      location.href = '../login/login.html';
    });

    let admin = localStorage.getItem('username');
    
    function announcements(){

      fetch('http://localhost:3000/admin/announcements/' + admin)
      .then(response => response.json())
      .then(data => {

        let delete_product_buttons = [];

        if(Object.keys(data).length > 0){
          data.forEach(item => {
            if (!document.getElementById('ann_' + item.announcement_id)){
              let container = document.createElement('div');
              container.className = 'container mt-4';

              let cardItem = document.createElement('div');
              cardItem.className = 'card';
              cardItem.id = 'ann_' + item.announcement_id;
              
              let header = document.createElement('div');
              header.className = 'card-header d-flex justify-content-between align-items-center';
              header.textContent = 'Announcement ID: ' + item.announcement_id;

              let button = document.createElement('button');
              button.type = 'button';
              button.className = 'btn btn-outline-danger';
              button.textContent = 'Delete';
              button.id = 'delete_announcement_btn_' + item.announcement_id;

              let body = document.createElement('div');
              body.className = 'card-body';
              body.id = 'body_' + item.announcement_id;
              body.innerHTML = `
                <div class="container d-flex justify-content-between align-items-center">
                  <p class="mb-0"><b>Product: </b>${item.product_name}</p>
                  <button type="button" class="btn btn-outline-danger" id="delete_product_btn_${item.announcement_id}_${item.id}">Delete</button>
                </div>
              `;
                
              header.appendChild(button);
              cardItem.appendChild(header);
              cardItem.appendChild(body);
              container.appendChild(cardItem);
              document.getElementById('announcements').appendChild(container);

              delete_product_buttons.push('delete_product_btn_' + item.announcement_id + '_' + item.id);

              document.getElementById('delete_announcement_btn_'+ item.announcement_id).addEventListener('click', function() {
                fetch('http://localhost:3000/delete/announcement/' + item.announcement_id + '/' + admin, { method: 'DELETE' })
                .then(response => response.text())
                .then(data => {
                  if(data == 'success') {
                    alert('Announcement was deleted successfully!');
                    document.getElementById('announcements').innerHTML = '';
                    announcements();
                  }
                }) 
                .catch(error => console.error('Error fetching data:', error));
              });

            }else{
              document.getElementById('body_' + item.announcement_id).innerHTML += `
                <div class="container d-flex justify-content-between align-items-center mt-3">
                  <p class="mb-0"><b>Product: </b>${item.product_name}</p>
                  <button type="button" class="btn btn-outline-danger" id="delete_product_btn_${item.announcement_id}_${item.id}">Delete</button>
                </div>
              `;

              delete_product_buttons.push('delete_product_btn_' + item.announcement_id + '_' + item.id);
            }
          });

          delete_product_buttons.forEach(item => {
            let button = document.getElementById(item);
            button.addEventListener('click', function() {
              announcement_id = this.id.split('_')[3];
              product_id = this.id.split('_')[4]; 
              fetch('http://localhost:3000/delete/announcement/product/' + announcement_id + '/' + product_id + '/' + admin, { method: 'DELETE' })
              .then(response => response.text())
              .then(data => {
                if(data == 'success') {
                  alert('Product was deleted successfully from announcement!');
                  document.getElementById('announcements').innerHTML = '';
                  announcements();
                }
              })
              .catch(error => console.error('Error fetching data:', error));
            });
          });

        }else{
          let listGroup = document.createElement('ul');
          listGroup.className = 'list-group';

          let listItem = document.createElement('li');
          listItem.className = 'list-group-item d-flex justify-content-center align-items-center';
          listItem.textContent = 'No announcements found';

          listGroup.appendChild(listItem);
          document.getElementById('announcements').appendChild(listGroup);
        }
      })
      .catch(error => console.error('Error fetching data:', error));
    }
    
    function newAnnouncement(){
      fetch('http://localhost:3000/base_inventory/admin/' + admin)
      .then(response => response.json())
      .then(data => {
        
        data.forEach(item => {
          const option = document.createElement('option');
          option.id = item.product_id;
          option.textContent = item.product_name;

          document.getElementById('product_select_menu').appendChild(option);
        });

      })
      .catch(error => console.error('Error fetching data:', error));

      document.getElementById("add_product_btn").addEventListener('click', function() {
        let div = document.createElement('div');
        div.className = 'mb-3 mt-3';

        let label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = 'Product:';

        let select = document.createElement('select');
        select.className = 'form-select';

        let option = document.createElement('option');
        option.id = '-1';
        option.textContent = 'Choose Product';

        select.appendChild(option);
        div.appendChild(label);
        div.appendChild(select);

        document.getElementById('add_product_btn_div').parentNode.insertBefore(div, document.getElementById('add_product_btn_div'));

        fetch('http://localhost:3000/base_inventory/admin/' + admin)
        .then(response => response.json())
        .then(data => {
          
          data.forEach(item => {
            const option = document.createElement('option');
            option.id = item.product_id;
            option.textContent = item.product_name;

            select.appendChild(option);
          });

        })
        .catch(error => console.error('Error fetching data:', error));
      });

      document.getElementById('add_announcement_btn').addEventListener('click', function() {
        let selectElements = document.querySelectorAll('select');
        let products = [];

        selectElements = Array.from(selectElements).filter(item => {
          if (item.options[item.selectedIndex].id != '-1') {
            return true;
          } else {
            return false;
          }
        });

        if(selectElements.length == 0) {
          alert('You have to add at least one product');
          return;
        }

        selectElements.forEach(item => {
          if(!products.includes(item.options[item.selectedIndex].id)){
            products.push(item.options[item.selectedIndex].id);
          }
        });

        fetch('http://localhost:3000/new_announcement/' + admin, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(products)
        })
        .then(response => response.text())
        .then(data => {
          if(data == 'success') {
            alert('Announcement was added successfully!');
            document.getElementById('new_announcement').innerHTML = `
              <div class="container text-white mt-5" id="test">
                <div class="row">
                  <div class="col-lg-3"></div>
                  
                  <div class="col-lg-6 rounded" style="background-color:rgb(80, 102, 80)">
                    <h3 class="text-center mt-3">New Announcement</h3>
                    <form class="p-3">
                      <div>
                        <label for="product" class="form-label">Product:</label>
                        <select class="form-select" id="product_select_menu">
                          <option id="-1">Choose Product</option>
                        </select>
                      </div>
                  
                      <div class="mb-3 mt-3 text-center" id="add_product_btn_div">
                        <button type="button" class="btn" id="add_product_btn">
                          <img src="../../imgs/add.png" class="img-thumbnail" width="40" height="40">
                          <label class="form-label text-white">Add Product</label>
                        </button>
                      </div>
          
                      <div class="mb-3 mt-3 text-center">
                        <button type="button" class="btn btn-primary btn-default mt-3" id="add_announcement_btn">Add Anouncement</button>
                      </div>
                    </form>
                  </div>
          
                </div>
              </div>
            `;
            newAnnouncement();
            document.getElementById('announcements').innerHTML = '';
            announcements();
          }
        })
        .catch(error => console.error('Error fetching data:', error));
      });
    }

    newAnnouncement();
    announcements();
    
  </script>

</html>