<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Service Statistics</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

        <script>
            if (sessionStorage.getItem('loggedIn') != 'yes') {
              window.location.href = "../login/login.html";
            }else if(sessionStorage.getItem('userType') != 'admin'){
              let user_type = sessionStorage.getItem('userType');
              window.location.href = '../' + user_type + '/' + user_type + '_home.html';
            }
        </script>
    </head>

    <style>
        .color-box{
            display: inline-block;
            width: 2em;
            height: 1em;
            margin-left: 0.5em;
            border: 1px solid rgb(0, 0, 0);
            border-radius: 3px;
        }
    </style>

    <body>
        <div class="container-fluid">
            <div class="row" style="background-color:rgb(80, 102, 80)">
              <div class="col-lg-5"></div>
      
              <div class="col-lg-2 mb-4">
                <img src="../../imgs/logo.png" class="img-thumbnail mt-4 mx-auto d-block" height="45" width="170">
              </div>
      
              <div class="col-lg-3"></div>
      
              <div class="col-lg-2 mt-4">
                <div class="btn-group">
                  <button type="button" class="btn btn-link" id="home_btn">
                    <img src="../../imgs/home.png" class="img-thumbnail" width="45" height="45">
                  </button>
      
                  <div class="dropdown">
                    <button type="button" class="btn btn-link" data-bs-toggle="dropdown">
                      <img src="../../imgs/user.png" class="img-thumbnail" width="45" height="45">
                    </button>
                    <div class="dropdown-menu p-3" id="user_info">
                      <script>
                        document.getElementById('user_info').innerHTML = `
                          <div class="text-center">
                            <b class="font-weight-bold">${sessionStorage.getItem('username')}</b>
                          </div>
                        `;
                      </script>
                    </div>
                  </div>
      
                  <button type="button" class="btn btn-link" id="power_btn">
                    <img src="../../imgs/power.png" class="img-thumbnail" width="45" height="45">
                  </button> 
                </div>  
              </div>
            </div>
        </div>


        <div class="container-fluid ms-2 mt-2">
            <div class="row">
                
                <div class="col-lg-3">
                    <form class="border border-3 rounded-4 ps-4 pt-4 mt-4">
                        <p class="h3 text-center mb-4">Toggles</p>

                        <div class="form-check mb-3 d-flex">
                            <input type="checkbox" class="form-check-input" id="check1" name="option1" value="something">
                            <label class="form-check-label ms-2" for="check1">New Requests</label>
                            <div class="color-box align-self-center" style="background-color: rgb(0, 85, 255);"></div>
                        </div>
                        
                        <div class="form-check mb-3 d-flex">
                            <input type="checkbox" class="form-check-input" id="check2" name="option2" value="something">
                            <label class="form-check-label ms-2" for="check2">Completed Requests</label>
                            <div class="color-box align-self-center" style="background-color: rgb(0, 230, 0);"></div>
                        </div>

                        <div class="form-check mb-3 d-flex">
                            <input type="checkbox" class="form-check-input" id="check3" name="option3" value="something">
                            <label class="form-check-label ms-2" for="check3">New Offers</label>
                            <div class="color-box align-self-center" style="background-color: rgb(255, 0, 0);"></div>
                        </div>

                        <div class="form-check mb-3 d-flex">
                            <input type="checkbox" class="form-check-input" id="check4" name="option4" value="something">
                            <label class="form-check-label ms-2" for="check4">Completed Offers</label>
                            <div class="color-box align-self-center" style="background-color: rgb(255, 204, 0);"></div>
                        </div>
                    </form>


                    <form class="border border-3 rounded-4 ps-4 pt-4 mt-4">
                        <p class="h3 text-center mb-4">Time Period</p>

                        <div class="mb-3">
                            <label for="start_date" class="form-label">Start Date:</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" lang="en">
                        </div>

                        <div class="mb-3">
                            <label for="end_date" class="form-label">End Date:</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" lang="en">
                        </div>

                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-primary" id="display_btn">Display</button>
                        </div>
                    </form>
                </div>

                <div class="col-lg-9 mt-2">
                    <canvas id="chart" style="height: 550px; width: 1000px;"></canvas>
                </div>
            </div>
        </div>
    </body>


    <script>
        document.getElementById('home_btn').addEventListener('click', function () {
            location.href = './admin_home.html';
        });
      
        document.getElementById('power_btn').addEventListener('click', function () {
            fetch('http://localhost:3000/logout', {method: 'POST'})
            .then(response => response.text())
            .then(data => {
                if (data == 'success') {
                sessionStorage.setItem('loggedIn', 'no');
                sessionStorage.setItem('userType', '');
                location.href = '../login/login.html';
                }
            })
            .catch(error => console.error('Error fetching data:', error));
        });
        
        document.getElementById('home_btn').addEventListener('click', function () {
            location.href = './admin_home.html';
        });
      
        document.getElementById('power_btn').addEventListener('click', function () {
            fetch('http://localhost:3000/logout', {method: 'POST'})
            .then(response => response.text())
            .then(data => {
              if (data == 'success') {
                sessionStorage.setItem('loggedIn', 'no');
                sessionStorage.setItem('userType', '');
                location.href = '../login/login.html';
              }
            })
            .catch(error => console.error('Error fetching data:', error));
        });

        document.getElementById('start_date').addEventListener('input', function() {
            document.getElementById('end_date').min = this.value;
        });

        document.getElementById('end_date').addEventListener('input', function() {
            document.getElementById('start_date').max = this.value;
        });


        let chart = new Chart('chart', {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                legend: {display: false},
                scales: {
                    yAxes: [{ticks: {min: 0, max: 30}}],
                }
            }
        });


        document.getElementById('display_btn').addEventListener('click' , function() {
            document.getElementById('check1').parentNode.replaceChild(document.getElementById('check1').cloneNode(true), document.getElementById('check1'));
            document.getElementById('check2').parentNode.replaceChild(document.getElementById('check2').cloneNode(true), document.getElementById('check2'));
            document.getElementById('check3').parentNode.replaceChild(document.getElementById('check3').cloneNode(true), document.getElementById('check3'));
            document.getElementById('check4').parentNode.replaceChild(document.getElementById('check4').cloneNode(true), document.getElementById('check4'));

            chart.data.datasets = [];

            let xValues = [];

            let start_date = new Date(document.getElementById('start_date').value);
            let end_date = new Date(document.getElementById('end_date').value);
            let difference_in_days = (end_date - start_date) / (1000 * 3600 * 24);

            for (let i = 0; i <= difference_in_days; i++) {
                let date = new Date(start_date);
                date.setDate(date.getDate() + i);
                xValues.push(date.toISOString().slice(0, 10));
            }

            chart.data.labels = xValues;
            chart.update();

            if (document.getElementById('check1').checked) {
                fetch('http://localhost:3000/get_tasks/request/new/' + start_date.toISOString().slice(0, 10) + '/' + end_date.toISOString().slice(0, 10))
                .then(response => response.json())
                .then(data => {
                    let yValues = [];

                    data.forEach(item => {
                        yValues.push(item.count);
                    })

                    chart.data.datasets.push({
                        fill: false,
                        lineTension: 0,
                        backgroundColor: "rgba(0, 85, 255, 1.0)",
                        borderColor: "rgba(0, 85, 255, 0.1)",
                        name: 'New Requests',
                        data: yValues
                    });

                    chart.update();
                })
                .catch(error => console.error('Error fetching data:', error));
            }

            if (document.getElementById('check2').checked) {
                fetch('http://localhost:3000/get_tasks/request/completed/' + start_date.toISOString().slice(0, 10) + '/' + end_date.toISOString().slice(0, 10))
                .then(response => response.json())
                .then(data => {
                    let yValues = [];

                    data.forEach(item => {
                        yValues.push(item.count);
                    })

                    chart.data.datasets.push({
                        fill: false,
                        lineTension: 0,
                        backgroundColor: "rgba(0, 230, 0, 1.0)",
                        borderColor: "rgba(0, 230, 0, 0.1)",
                        name: 'Completed Requests',
                        data: yValues
                    });

                    chart.update();
                })
                .catch(error => console.error('Error fetching data:', error));
            }

            if (document.getElementById('check3').checked) {
                fetch('http://localhost:3000/get_tasks/offer/new/' + start_date.toISOString().slice(0, 10) + '/' + end_date.toISOString().slice(0, 10))
                .then(response => response.json())
                .then(data => {
                    let yValues = [];

                    data.forEach(item => {
                        yValues.push(item.count);
                    })

                    chart.data.datasets.push({
                        fill: false,
                        lineTension: 0,
                        backgroundColor: "rgba(255, 0, 0, 1.0)",
                        borderColor: "rgba(255, 0, 0, 0.1)",
                        name: 'New Offers',
                        data: yValues
                    });

                    chart.update();
                })
                .catch(error => console.error('Error fetching data:', error));
            }

            if (document.getElementById('check4').checked) {
                fetch('http://localhost:3000/get_tasks/offer/completed/' + start_date.toISOString().slice(0, 10) + '/' + end_date.toISOString().slice(0, 10))
                .then(response => response.json())
                .then(data => {
                    let yValues = [];

                    data.forEach(item => {
                        yValues.push(item.count);
                    })

                    chart.data.datasets.push({
                        fill: false,
                        lineTension: 0,
                        backgroundColor: "rgba(255, 204, 0, 1.0)",
                        borderColor: "rgba(255, 204, 0, 0.1)",
                        name: 'Completed Offers',
                        data: yValues
                    });

                    chart.update();
                })
                .catch(error => console.error('Error fetching data:', error));
            }   

                
            document.getElementById('check1').addEventListener('change', function() {
                if (document.getElementById('check1').checked) {
                    fetch('http://localhost:3000/get_tasks/request/new/' + start_date.toISOString().slice(0, 10) + '/' + end_date.toISOString().slice(0, 10))
                    .then(response => response.json())
                    .then(data => {
                        let yValues = [];
    
                        data.forEach(item => {
                            yValues.push(item.count);
                        })
    
                        chart.data.datasets.push({
                            fill: false,
                            lineTension: 0,
                            backgroundColor: "rgba(0, 85, 255, 1.0)",
                            borderColor: "rgba(0, 85, 255, 0.1)",
                            name: 'New Requests',
                            data: yValues
                        });
    
                        chart.update();
                    })
                    .catch(error => console.error('Error fetching data:', error));
                }else{
                    for(let i = 0; i < chart.data.datasets.length; i++) {
                        if(chart.data.datasets[i].name == 'New Requests') {
                            chart.data.datasets.splice(i, 1);
                            chart.update();
                            break;
                        }
                    }
                }
            });


            document.getElementById('check2').addEventListener('change', function(){
                if (document.getElementById('check2').checked) {
                    fetch('http://localhost:3000/get_tasks/request/completed/' + start_date.toISOString().slice(0, 10) + '/' + end_date.toISOString().slice(0, 10))
                    .then(response => response.json())
                    .then(data => {
                        let yValues = [];

                        data.forEach(item => {
                            yValues.push(item.count);
                        })

                        chart.data.datasets.push({
                            fill: false,
                            lineTension: 0,
                            backgroundColor: "rgba(0, 230, 0, 1.0)",
                            borderColor: "rgba(0, 230, 0, 0.1)",
                            name: 'Completed Requests',
                            data: yValues
                        });

                        chart.update();
                    })
                    .catch(error => console.error('Error fetching data:', error));
                }else{
                    for(let i = 0; i < chart.data.datasets.length; i++) {
                        if(chart.data.datasets[i].name == 'Completed Requests') {
                            chart.data.datasets.splice(i, 1);
                            chart.update();
                            break;
                        }
                    }
                }
            });


            document.getElementById('check3').addEventListener('change', function(){
                if (document.getElementById('check3').checked) {
                    fetch('http://localhost:3000/get_tasks/offer/new/' + start_date.toISOString().slice(0, 10) + '/' + end_date.toISOString().slice(0, 10))
                    .then(response => response.json())
                    .then(data => {
                        let yValues = [];

                        data.forEach(item => {
                            yValues.push(item.count);
                        })

                        chart.data.datasets.push({
                            fill: false,
                            lineTension: 0,
                            backgroundColor: "rgba(255, 0, 0, 1.0)",
                            borderColor: "rgba(255, 0, 0, 0.1)",
                            name: 'New Offers',
                            data: yValues
                        });

                        chart.update();
                    })
                    .catch(error => console.error('Error fetching data:', error));
                }else{
                    for(let i = 0; i < chart.data.datasets.length; i++) {
                        if(chart.data.datasets[i].name == 'New Offers') {
                            chart.data.datasets.splice(i, 1);
                            chart.update();
                            break;
                        }
                    }
                }
            });


            document.getElementById('check4').addEventListener('change', function(){
                if (document.getElementById('check4').checked) {
                    fetch('http://localhost:3000/get_tasks/offer/completed/' + start_date.toISOString().slice(0, 10) + '/' + end_date.toISOString().slice(0, 10))
                    .then(response => response.json())
                    .then(data => {
                        let yValues = [];

                        data.forEach(item => {
                            yValues.push(item.count);
                        })

                        chart.data.datasets.push({
                            fill: false,
                            lineTension: 0,
                            backgroundColor: "rgba(255, 204, 0, 1.0)",
                            borderColor: "rgba(255, 204, 0, 0.1)",
                            name: 'Completed Offers',
                            data: yValues
                        });

                        chart.update();
                    })
                    .catch(error => console.error('Error fetching data:', error));
                }else{
                    for(let i = 0; i < chart.data.datasets.length; i++) {
                        if(chart.data.datasets[i].name == 'Completed Offers') {
                            chart.data.datasets.splice(i, 1);
                            chart.update();
                            break;
                        }
                    }
                }
            });
        });

    </script>

</html>