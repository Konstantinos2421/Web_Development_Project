<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Map</title>
        <link rel="stylesheet" href="../../bootstrap-5.3.2-dist/css/bootstrap.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    </head>

    <body>

        <div class="container-fluid">
            <div class="row" style="background-color:rgb(80, 102, 80)">
              <div class="col-lg-5"></div>
      
              <div class="col-lg-2 mb-4">
                <img src="../../imgs/logo.png" class="img-thumbnail mt-4 mx-auto d-block" height="45" width="170">
              </div>
      
              <div class="col-lg-3"></div>
      
              <div class="col-lg-2 mt-4">
                <div class="btn-group">
                  <button type="button" class="btn btn-link">
                    <img src="../../imgs/home.png" class="img-thumbnail" width="45" height="45">
                  </button>
      
                  <button type="button" class="btn btn-link">
                    <img src="../../imgs/user.png" class="img-thumbnail" width="45" height="45">
                  </button>
      
                  <button type="button" class="btn btn-link">
                    <img src="../../imgs/power.png" class="img-thumbnail" width="45" height="45">
                  </button> 
                </div>  
              </div>
            </div>
        </div>

        <div class="container-fluid mt-4">
            <div class="row">

                <div class="col-lg-3">
                    <form class="border border-3 rounded-4 ps-4 pt-4">
                        <p class="h3 text-center mb-4">Toggles</p>

                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="check1" name="option1" value="something">
                            <label class="form-check-label" for="check1">Accepted Requests</label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="check2" name="option2" value="something">
                            <label class="form-check-label" for="check2">Unaccepted Requests</label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="check3" name="option3" value="something">
                            <label class="form-check-label" for="check3">Accepted Offers</label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="check4" name="option4" value="something">
                            <label class="form-check-label" for="check4">Unaccepted Offers</label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="check5" name="option5" value="something">
                            <label class="form-check-label" for="check5">Vehicles With Active Tasks</label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="check6" name="option6" value="something">
                            <label class="form-check-label" for="check6">Vehicles Without Active Tasks</label>
                        </div>

                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="check7" name="option7" value="something">
                            <label class="form-check-label" for="check7">Lines</label>
                        </div>
                    </form>

                    <div class="mt-5 text-center">
                        <button type="button" class="btn btn-outline-primary" id="new_location_btn" disabled>Change Base Location</button>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div id="map" style="height: 550px; width: 1000px;"></div>
                </div>

            </div>
        </div>

    </body>

    <script>
        let map = L.map('map').setView([38.2904, 21.7957], 14);
          
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        fetch('http://localhost:3000/base_location/admin/stavros_paraskevopoulos')
        .then(response => response.json())
        .then(data => {
            let lat = data.base_location.x;
            let lng = data.base_location.y;

            map.setView([lat, lng], 14);

            let marker = L.marker([lat, lng],{
                icon: L.icon({
                    iconUrl: '../../imgs/pins/marker-icon-2x-black.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                })
            });

            marker.addTo(map);
            marker.bindPopup(`
                <div class="text-center">
                    <b class="font-weight-bold">Base</b>
                </div>

                <p><b>Base Name: </b>${data.base_name}</p>
                <p><b>Location: </b>${lat.toFixed(4)} ${lng.toFixed(4)}</p>
            `);
        })
        .catch(error => console.error('Error fetching data:', error));

        let new_base_marker;
        let new_base_lat, new_base_lng;
        map.on('click', function(e) {
            new_base_lat = e.latlng.lat;
            new_base_lng = e.latlng.lng;

            if (new_base_marker) {
                map.removeLayer(new_base_marker);
            }

            new_base_marker = L.marker([new_base_lat, new_base_lng]).addTo(map);
            document.getElementById('new_location_btn').disabled = false;
        });


        document.getElementById('new_location_btn').addEventListener('click', function(){
            fetch('http://localhost:3000/change_base_location/' + new_base_lat + '/' + new_base_lng + '/stavros_paraskevopoulos', {method: 'POST'})
            .then(response => response.text())
            .then(data => {
                if(data == 'success') {
                    alert('Base location changed successfully!');
                    window.location.href = 'admin3_4.html';
                }
            })
            .catch(error => console.error('Error fetching data:', error));
        });


        let acceptedRequestsLayer = L.layerGroup();
        document.getElementById('check1').addEventListener('change', function(){
            if(document.getElementById('check1').checked){
                fetch('http://localhost:3000/accepted/requests')
                .then(response => response.json())
                .then(data => {
                    
                    data.forEach(item => {
                        let lat = item.citizen_location.x;
                        let lng = item.citizen_location.y;
                       
                        let marker = L.marker([lat, lng],{
                            icon: L.icon({
                                iconUrl: '../../imgs/pins/marker-icon-2x-orange.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        });

                        marker.addTo(acceptedRequestsLayer);
                        marker.bindPopup(`
                            <div class="text-center">
                                <b class="font-weight-bold">Request</b>
                            </div>
                            
                            <p><b>Name: </b>${item.first_name} ${item.last_name}</p>
                            <p><b>Phone: </b>${item.phone_num}</p>
                            <p><b>Product: </b>${item.product_name}</p>
                            <p><b>Persons: </b>${item.persons_num}</p>
                            <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -4)}</p>
                            <p><b>Takeover Date: </b>${item.accept_date.replace('T','  ').slice(0, -4)}</p>
                            <p><b>Vehicle: </b>${item.vehicle}</p>
                        `);
                    });

                    map.addLayer(acceptedRequestsLayer);

                })
                .catch(error => console.error('Error fetching data:', error));
            }
            else{
                acceptedRequestsLayer.clearLayers();
            }
        });

        let unacceptedRequestsLayer = L.layerGroup();
        document.getElementById('check2').addEventListener('change', function(){
            if(document.getElementById('check2').checked){
                fetch('http://localhost:3000/unaccepted/requests')
                .then(response => response.json())
                .then(data => {
                    
                    data.forEach(item => {
                        let lat = item.citizen_location.x;
                        let lng = item.citizen_location.y;
                       
                        let marker = L.marker([lat, lng],{
                            icon: L.icon({
                                iconUrl: '../../imgs/pins/marker-icon-2x-red.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        });

                        marker.addTo(unacceptedRequestsLayer);
                        marker.bindPopup(`
                            <div class="text-center">
                                <b class="font-weight-bold">Request</b>
                            </div>
                            
                            <p><b>Name: </b>${item.first_name} ${item.last_name}</p>
                            <p><b>Phone: </b>${item.phone_num}</p>
                            <p><b>Product: </b>${item.product_name}</p>
                            <p><b>Persons: </b>${item.persons_num}</p>
                            <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -4)}</p>
                        `);
                    });
                    map.addLayer(unacceptedRequestsLayer);
                })
                .catch(error => console.error('Error fetching data:', error));
            }
            else{
                unacceptedRequestsLayer.clearLayers();
            }
        });

        let acceptedOffersLayer = L.layerGroup();
        document.getElementById('check3').addEventListener('change', function(){
            if(document.getElementById('check3').checked){
                fetch('http://localhost:3000/accepted/offers')
                .then(response => response.json())
                .then(data => {

                    data.forEach(item => {
                        let lat = item.citizen_location.x;
                        let lng = item.citizen_location.y;
                        
                        let marker = L.marker([lat, lng],{
                            icon: L.icon({
                                iconUrl: '../../imgs/pins/marker-icon-2x-green.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        });

                        marker.addTo(acceptedOffersLayer);
                        marker.bindPopup(`
                            <div class="text-center">
                                <b class="font-weight-bold">Offer</b>
                            </div>
                            
                            <p><b>Name: </b>${item.first_name} ${item.last_name}</p>
                            <p><b>Phone: </b>${item.phone_num}</p>
                            <p><b>Product: </b>${item.product_name}</p>
                            <p><b>Quantity: </b>${item.quantity}</p>
                            <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -4)}</p>
                            <p><b>Takeover Date: </b>${item.accept_date.replace('T','  ').slice(0, -4)}</p>
                            <p><b>Vehicle: </b>${item.vehicle}</p>
                        `);
                    });
                    map.addLayer(acceptedOffersLayer);
                })
                .catch(error => console.error('Error fetching data:', error));
            }
            else{
                acceptedOffersLayer.clearLayers();
            }
        });

        let unacceptedOffersLayer = L.layerGroup();
        document.getElementById('check4').addEventListener('change', function(){
            if(document.getElementById('check4').checked){
                fetch('http://localhost:3000/unaccepted/offers')
                .then(response => response.json())
                .then(data => {
                    
                    data.forEach(item => {
                        let lat = item.citizen_location.x;
                        let lng = item.citizen_location.y;
                        
                        let marker = L.marker([lat, lng],{
                            icon: L.icon({
                                iconUrl: '../../imgs/pins/marker-icon-2x-grey.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        });

                        marker.addTo(unacceptedOffersLayer);
                        marker.bindPopup(`
                            <div class="text-center">
                                <b class="font-weight-bold">Offer</b>
                            </div>
                            
                            <p><b>Name: </b>${item.first_name} ${item.last_name}</p>
                            <p><b>Phone: </b>${item.phone_num}</p>
                            <p><b>Product: </b>${item.product_name}</p>
                            <p><b>Quantity: </b>${item.quantity}</p>
                            <p><b>Registration Date: </b>${item.reg_date.replace('T','  ').slice(0, -4)}</p>
                        `);
                    });
                    map.addLayer(unacceptedOffersLayer);
                })
                .catch(error => console.error('Error fetching data:', error));
            }
            else{
                unacceptedOffersLayer.clearLayers();
            }
        });

        let vehiclesWithActiveTasksLayer = L.layerGroup();
        document.getElementById('check5').addEventListener('change', function(){
            if(document.getElementById('check5').checked){
                let admin = sessionStorage.getItem('username');

                fetch('http://localhost:3000/vehicles/active_tasks/stavros_paraskevopoulos')
                .then(response => response.json())
                .then(data => {
                    
                    data.forEach(item => {
                        let lat = item.vehicle_location.x;
                        let lng = item.vehicle_location.y;
                        
                        let marker = L.marker([lat, lng],{
                            icon: L.icon({
                                iconUrl: '../../imgs/pins/marker-icon-2x-violet.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        });

                        marker.addTo(vehiclesWithActiveTasksLayer);
                        marker.bindPopup(`
                            <div class="text-center">
                                <b class="font-weight-bold">Vehicle</b>
                            </div>
                            
                            <p><b>Name: </b>${item.first_name} ${item.last_name}</p>
                            <p><b>Phone: </b>${item.phone_num}</p>
                            <p><b>Vehicle Username: </b>${item.vehicle}</p>
                        `);
                    });

                    map.addLayer(vehiclesWithActiveTasksLayer);
                })
                .catch(error => console.error('Error fetching data:', error));
            }
            else{
                vehiclesWithActiveTasksLayer.clearLayers();
            }
        });

        let vehiclesWithNoActiveTasksLayer = L.layerGroup();
        document.getElementById('check6').addEventListener('change', function(){
            if(document.getElementById('check6').checked){
                let admin = sessionStorage.getItem('username');

                fetch('http://localhost:3000/vehicles/no_active_tasks/stavros_paraskevopoulos')
                .then(response => response.json())
                .then(data => {
                    
                    data.forEach(item => {
                        let lat = item.vehicle_location.x;
                        let lng = item.vehicle_location.y;
                        
                        let marker = L.marker([lat, lng],{
                            icon: L.icon({
                                iconUrl: '../../imgs/pins/marker-icon-2x-yellow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        });

                        marker.addTo(vehiclesWithNoActiveTasksLayer);
                        marker.bindPopup(`
                            <div class="text-center">
                                <b class="font-weight-bold">Vehicle</b>
                            </div>
                            
                            <p><b>Name: </b>${item.first_name} ${item.last_name}</p>
                            <p><b>Phone: </b>${item.phone_num}</p>
                            <p><b>Vehicle Username: </b>${item.vehicle}</p>
                        `);
                    });

                    map.addLayer(vehiclesWithNoActiveTasksLayer);
                })
                .catch(error => console.error('Error fetching data:', error));
            }
            else{
                vehiclesWithNoActiveTasksLayer.clearLayers();
            }
        });


        let linesLayer = L.layerGroup();
        document.getElementById('check7').addEventListener('change', function(){
            if(document.getElementById('check7').checked){
                fetch('http://localhost:3000/coordinates_for_map_lines/stavros_paraskevopoulos')
                .then(response => response.json())
                .then(data => {
                    data.forEach(item => {
                        let citizen_lat = item.citizen_location.x;
                        let citizen_lng = item.citizen_location.y;

                        let rescuer_lat = item.rescuer_location.x;
                        let rescuer_lng = item.rescuer_location.y;

                        let line = L.polyline([L.latLng(citizen_lat, citizen_lng), L.latLng(rescuer_lat, rescuer_lng)], {color: 'black'});
                        line.addTo(linesLayer);
                    });
                    map.addLayer(linesLayer);
                })
                .catch(error => console.error('Error fetching data:', error));
            }
            else{
                linesLayer.clearLayers();
            }
        });

    </script>

</html>